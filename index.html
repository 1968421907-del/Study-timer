<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Study & Break Timer (Stable)</title>
  <style>
    * { box-sizing: border-box; font-family: system-ui, sans-serif; }
    body { margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center; transition: background-color .6s ease; }
    .app { background:rgba(255,255,255,.92); padding:22px 26px 26px; border-radius:18px; width:100%; max-width:420px; text-align:center; box-shadow:0 20px 40px rgba(0,0,0,.18); }
    h1 { margin:0 0 6px; }
    .phase { font-weight:600; margin-bottom:10px; }
    .timer { font-size:3rem; font-weight:800; margin:8px 0 16px; }
    .section { margin-bottom:14px; }
    .buttons { display:grid; grid-template-columns:repeat(auto-fit,minmax(64px,1fr)); gap:8px; }
    button { padding:10px; border:none; border-radius:10px; background:#222; color:#fff; font-weight:700; cursor:pointer; }
    button.secondary { background:#666; }
    button.danger { background:#b00020; }
    .controls { display:flex; gap:10px; justify-content:center; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="app">
    <h1>Study Timer</h1>
    <div class="phase" id="phase">Choose a study time</div>
    <div class="timer" id="timer">00:00</div>

    <div class="section" id="studySection">
      <div class="buttons" id="studyButtons"></div>
    </div>

    <div class="section hidden" id="breakSection">
      <div class="buttons" id="breakButtons"></div>
    </div>

    <div class="controls">
      <button class="secondary" id="pauseBtn">Pause</button>
      <button class="secondary hidden" id="muteBtn">Mute</button>
      <button class="danger" id="resetBtn">Reset</button>
    </div>
  </div>

  <!-- YouTube API (hidden players) -->
  <div id="studyPlayer" style="display:none"></div>
  <div id="breakPlayer" style="display:none"></div>
  <script src="https://www.youtube.com/iframe_api"></script>

  <script>
    // ===== CONFIG =====
    const STUDY_TIMES = [5,10,15,20,25,30,45];
    const BREAK_TIMES = [2,3,5,8,10,15];
    const COLORS = ['#ff9ecf','#b57cff','#7ed957','#6ecbff'];

    // ===== STATE =====
    let phase = 'idle'; // 'idle' | 'study' | 'break'
    let intervalId = null;
    let remaining = 0;
    let studyMinutes = null;
    let colorIndex = 0;
    let muted = false;

    // ===== ELEMENTS =====
    const timerEl = document.getElementById('timer');
    const phaseEl = document.getElementById('phase');
    const studySection = document.getElementById('studySection');
    const breakSection = document.getElementById('breakSection');
    const studyButtonsEl = document.getElementById('studyButtons');
    const breakButtonsEl = document.getElementById('breakButtons');
    const pauseBtn = document.getElementById('pauseBtn');
    const resetBtn = document.getElementById('resetBtn');
    const muteBtn = document.getElementById('muteBtn');

    // ===== PLAYERS =====
    let studyPlayer = null;
    let breakPlayer = null;

    // ===== HELPERS =====
    const fmt = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
    const nextBg = () => { document.body.style.backgroundColor = COLORS[colorIndex]; colorIndex = (colorIndex+1)%COLORS.length; };

    function stopAllAudio(){ studyPlayer?.pauseVideo(); breakPlayer?.pauseVideo(); }

    // ===== TIMER CORE (NO RE-ENTRY) =====
    function tick(){
      remaining--;
      timerEl.textContent = fmt(remaining);
      if(remaining <= 0){
        clearInterval(intervalId);
        intervalId = null;
        if(phase === 'study'){
          // Study ended → show break choices (NO sound)
          stopAllAudio();
          phase = 'idle';
          breakSection.classList.remove('hidden');
          phaseEl.textContent = 'Choose a break time';
        } else if(phase === 'break'){
          // Break ended → play alert once, then restart study
          stopAllAudio();
          breakPlayer?.playVideo();
          setTimeout(()=>{
            breakPlayer?.pauseVideo();
            startStudy(studyMinutes);
          }, 1500);
        }
      }
    }

    function startStudy(min){
      clearInterval(intervalId);
      phase = 'study';
      remaining = min * 60;
      timerEl.textContent = fmt(remaining);
      phaseEl.textContent = 'Studying';
      studySection.classList.add('hidden');
      breakSection.classList.add('hidden');
      nextBg();
      if(studyPlayer){ breakPlayer?.pauseVideo(); studyPlayer.playVideo(); muted?studyPlayer.mute():studyPlayer.unMute(); }
      muteBtn.classList.remove('hidden');
      intervalId = setInterval(tick, 1000);
    }

    function startBreak(min){
      clearInterval(intervalId);
      phase = 'break';
      remaining = min * 60;
      timerEl.textContent = fmt(remaining);
      phaseEl.textContent = 'On break';
      document.body.style.backgroundColor = '#f5f5f5';
      stopAllAudio();
      muteBtn.classList.add('hidden');
      intervalId = setInterval(tick, 1000);
    }

    // ===== BUTTONS =====
    STUDY_TIMES.forEach(min=>{
      const b = document.createElement('button');
      b.textContent = `${min} min`;
      b.onclick = () => { studyMinutes = min; startStudy(min); };
      studyButtonsEl.appendChild(b);
    });

    BREAK_TIMES.forEach(min=>{
      const b = document.createElement('button');
      b.textContent = `${min} min`;
      b.onclick = () => startBreak(min);
      breakButtonsEl.appendChild(b);
    });

    pauseBtn.onclick = () => {
      if(!intervalId) return;
      clearInterval(intervalId);
      intervalId = null;
      stopAllAudio();
      pauseBtn.textContent = 'Resume';
    };

    pauseBtn.addEventListener('click', ()=>{
      if(pauseBtn.textContent === 'Resume' && intervalId === null && phase !== 'idle'){
        intervalId = setInterval(tick, 1000);
        pauseBtn.textContent = 'Pause';
        if(phase==='study' && studyPlayer){ studyPlayer.playVideo(); muted?studyPlayer.mute():studyPlayer.unMute(); }
      }
    });

    resetBtn.onclick = () => {
      clearInterval(intervalId);
      intervalId = null;
      phase = 'idle';
      studyMinutes = null;
      remaining = 0;
      timerEl.textContent = '00:00';
      phaseEl.textContent = 'Choose a study time';
      studySection.classList.remove('hidden');
      breakSection.classList.add('hidden');
      document.body.style.backgroundColor = '#ffffff';
      muteBtn.classList.add('hidden');
      pauseBtn.textContent = 'Pause';
      stopAllAudio();
    };

    muteBtn.onclick = () => {
      muted = !muted;
      muteBtn.textContent = muted ? 'Unmute' : 'Mute';
      if(studyPlayer){ muted ? studyPlayer.mute() : studyPlayer.unMute(); }
    };

    // ===== YT API =====
    function onYouTubeIframeAPIReady(){
      studyPlayer = new YT.Player('studyPlayer', { videoId: '6d8CbHqXD9Y', playerVars: { autoplay: 0, loop: 1, playlist: '6d8CbHqXD9Y' } });
      breakPlayer = new YT.Player('breakPlayer', { videoId: 'LH0xb6g0o_k', playerVars: { autoplay: 0 } });
    }
  </script>
</body>
</html>
